<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        position: relative; /* Add this */
      }

      .container {
        padding: 2rem;
        width: 450px;
        text-align: center;
        background: rgba(
          255,
          255,
          255,
          0.8
        ); /* Set background with transparency */
        border: 2px solid #333;
        border-radius: 8px;
        z-index: 1; /* Add this */
        position: relative; /* Add this */
      }
      h1 {
        font-family: Helvetica, Arial, sans-serif;
        font-size: 28px;
        color: #333;
        margin-bottom: 1.5rem;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      button {
        background-color: #333;
        color: #fff;
        border: none;
        padding: 12px 25px;
        margin-top: 1rem;
        margin-bottom: 1rem;
        font-size: 16px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      button:hover {
        background-color: #555;
      }
      input[type="file"] {
        width: 100%;

        font-size: 16px;
      }
      .results {
        text-align: left;
      }
      .results p {
        font-size: 16px;
        margin: 0.5rem 0;
        font-weight: 600;
      }
      .results span {
        display: inline-block;
        opacity: 0.4;
        transform: scale(0.8);
        transition: opacity 0.6s ease, transform 0.6s ease;
      }
      .results span.populated {
        opacity: 1;
        transform: scale(1.2);
        animation: scaleDown 0.6s ease forwards;
      }
      @keyframes scaleDown {
        0% {
          transform: scale(1.5);
        }
        100% {
          transform: scale(1);
        }
      }
      a {
        display: inline-block;
        margin-top: 1.5rem;
        color: #333;
        text-decoration: none;
        font-weight: bold;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: color 0.3s ease;
      }
      a:hover {
        color: #555;
      }
      input[type="file"] {
        width: 100%;
        font-size: 16px;
        display: block;
        margin: 0 auto; /* Center the file input */
      }

      body {
        overflow: hidden;
      }
      svg {
        width: 100vw;
        height: 100vh;
        position: absolute; /* Add this */
        top: 0;
        left: 0;
        z-index: 0; /* Add this */
      }
      .back {
        position: fixed;
        padding: 0;
        margin: 0;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        animation-name: backdiv;
        animation-duration: 1s;
        animation-iteration-count: infinite;
        z-index: 9;
      }
      .hidden {
        display: none;
      }
      .heart {
        position: absolute;
        margin: auto;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: pink;
        height: 50px;
        width: 50px;
        transform: rotate(-45deg);
        animation-name: beat;
        animation-duration: 1s;
        animation-iteration-count: infinite;
        z-index: 10;
      }
      .heart:after {
        background-color: pink;
        content: "";
        border-radius: 50%;
        position: absolute;
        width: 50px;
        height: 50px;
        top: 0px;
        left: 25px;
      }
      .heart:before {
        background-color: pink;
        content: "";
        border-radius: 50%;
        position: absolute;
        width: 50px;
        height: 50px;
        top: -25px;
        left: 0px;
      }

      @keyframes backdiv {
        50% {
          background: rgba(255, 230, 242, 0.8);
        }
      }

      @keyframes beat {
        0% {
          transform: scale(1) rotate(-45deg);
        }
        50% {
          transform: scale(0.6) rotate(-45deg);
        }
      }
      .editorial {
        z-index: 100;
        opacity: 0.8;
      }
      .loading-waves > use {
        animation: move-forever 12s linear infinite;
        &:nth-child(1) {
          animation-delay: -3s;
        }
        &:nth-child(2) {
          animation-delay: -4s;
          animation-duration: 2s;
        }
        &:nth-child(3) {
          animation-delay: -6s;
          animation-duration: 3s;
        }
      }

      @keyframes move-forever {
        0% {
          transform: translate(-90px, 0%);
        }
        100% {
          transform: translate(85px, 0%);
        }
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const colors = [
          "#e03776",
          "#8f3e98",
          "#4687bf",
          "#3bab6f",
          "#f9c25e",
          "#f47274",
        ];
        const SVG_NS = "http://www.w3.org/2000/svg";
        const SVG_XLINK = "http://www.w3.org/1999/xlink";

        let heartsRy = [];

        function useTheHeart(n) {
          let use = document.createElementNS(SVG_NS, "use");
          use.n = n;
          use.setAttributeNS(SVG_XLINK, "xlink:href", "#heart");
          use.setAttributeNS(null, "transform", `scale(${use.n})`);
          use.setAttributeNS(null, "fill", colors[n % colors.length]);
          use.setAttributeNS(null, "x", -69);
          use.setAttributeNS(null, "y", -69);
          use.setAttributeNS(null, "width", 138);
          use.setAttributeNS(null, "height", 138);

          heartsRy.push(use);
          hearts.appendChild(use);
        }

        for (let n = 18; n >= 0; n--) {
          useTheHeart(n);
        }

        function Frame() {
          window.requestAnimationFrame(Frame);
          for (let i = 0; i < heartsRy.length; i++) {
            if (heartsRy[i].n < 18) {
              heartsRy[i].n += 0.01;
            } else {
              heartsRy[i].n = 0;
              hearts.appendChild(heartsRy[i]);
            }
            heartsRy[i].setAttributeNS(
              null,
              "transform",
              `scale(${heartsRy[i].n})`
            );
          }
        }

        Frame();

        const generateButton = document.querySelector(
          'button[name="generate_primes_and_calculate"]'
        );
        const pElement = document.querySelector("#prime-p");
        const qElement = document.querySelector("#prime-q");
        const cElement = document.querySelector("#c-value");
        const uploadButton = document.querySelector("#upload-button");
        const hiddenPrimeP = document.querySelector("#hidden-prime-p");
        const hiddenPrimeQ = document.querySelector("#hidden-prime-q");
        const hiddenCValue = document.querySelector("#hidden-c-value");
        const fileInput = document.querySelector("#csv_file");
        const form = document.querySelector("#upload-form");
        const loadingElement = document.querySelector(".editorial");

        // Show "Not generated" text on page load
        pElement.textContent = "Not generated";
        qElement.textContent = "Not generated";
        cElement.textContent = "Not generated";
        let baseUrl = window.location.href; // Get the base URL
        // Remove trailing slash if it exists
        if (baseUrl.endsWith("/")) {
          baseUrl = baseUrl.slice(0, -1);
        }

        // set form action to baseUrl / /upload_csv
        form.action = `${baseUrl}/upload_csv`;
        generateButton.disabled = false; // Initially disable the generate button
        generateButton.addEventListener("click", function (event) {
          event.preventDefault(); // Prevent the default form submission

          // Lock the button after it's pressed once
          generateButton.disabled = true;
          const fetchUrl = `${baseUrl}/generate_primes`; // Construct the full URL

          loadingElement.classList.remove("hidden");

          fetch(fetchUrl)
            .then((response) => response.json())
            .then((data) => {
              // Update the text content of the existing elements
              updateWithAnimation(pElement, data.p);
              updateWithAnimation(qElement, data.q);
              updateWithAnimation(cElement, data.c);

              // Set hidden input values
              hiddenPrimeP.value = data.p;
              hiddenPrimeQ.value = data.q;
              hiddenCValue.value = data.c;

              // Enable the upload button if all parameters are valid and a file is chosen
              if (data.p && data.q && data.c && fileInput.files.length > 0) {
                uploadButton.disabled = false;
                uploadButton.style.backgroundColor = ""; // Reset to default color
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              // Re-enable the button in case of error
              generateButton.disabled = false;
              generateButton.textContent = "Generating Parameters";
            })
            .finally(() => {
              // Hide the loading animation
              loadingElement.classList.add("hidden");
            });
        });

        function updateWithAnimation(element, value) {
          element.textContent = value;
          element.classList.remove("populated");
          // Trigger a reflow to restart the animation
          void element.offsetWidth;
          element.classList.add("populated");
        }

        // Add event listeners for the edit buttons
        // Add event listeners for the edit buttons
        document.querySelectorAll(".edit-button").forEach((button) => {
          button.addEventListener("click", function () {
            const targetId = this.getAttribute("data-target");
            const targetElement = document.getElementById(targetId);
            const currentValue = targetElement.textContent;

            // Replace the text with an input field
            const input = document.createElement("input");
            input.type = "text";
            input.value = currentValue;
            input.addEventListener("blur", function () {
              // Update the text content with the new value
              updateWithAnimation(targetElement, input.value);
              targetElement.style.display = "inline";
              input.remove();
              button.textContent = "Edit"; // Change button text back to "Edit"

              // Update hidden input values
              if (targetId === "prime-p") {
                hiddenPrimeP.value = input.value;
              } else if (targetId === "prime-q") {
                hiddenPrimeQ.value = input.value;
              } else if (targetId === "c-value") {
                hiddenCValue.value = input.value;
              }

              // Check if the upload button can be enabled
              if (
                hiddenPrimeP.value &&
                hiddenPrimeQ.value &&
                hiddenCValue.value &&
                fileInput.files.length > 0
              ) {
                uploadButton.disabled = false;
                uploadButton.style.backgroundColor = ""; // Reset to default color
              } else {
                uploadButton.disabled = true;
                uploadButton.style.backgroundColor = "rgba(128, 128, 128, 0.5)"; // Translucent grey
              }
            });

            targetElement.style.display = "none";
            targetElement.parentNode.insertBefore(
              input,
              targetElement.nextSibling
            );
            input.focus();
            button.textContent = "Update Value"; // Change button text to "Update Value"
          });
        });

        // Initially grey out the upload button
        uploadButton.style.backgroundColor = "rgba(128, 128, 128, 0.5)"; // Translucent grey
        uploadButton.disabled = true;

        // Enable the upload button only if a file is chosen and parameters are generated
        fileInput.addEventListener("change", function () {
          if (
            fileInput.files.length > 0 &&
            hiddenPrimeP.value &&
            hiddenPrimeQ.value &&
            hiddenCValue.value
          ) {
            uploadButton.disabled = false;
            uploadButton.style.backgroundColor = ""; // Reset to default color
          } else {
            uploadButton.disabled = true;
            uploadButton.style.backgroundColor = "rgba(128, 128, 128, 0.5)"; // Translucent grey
          }
        });

        // Update hidden input values before form submission
        form.addEventListener("submit", function (event) {
          hiddenPrimeP.value = pElement.textContent;
          hiddenPrimeQ.value = qElement.textContent;
          hiddenCValue.value = cElement.textContent;
        });
      });
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HGSU Async Voting ID Generator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <svg
      id="hearts"
      viewBox="-600 -400 1200 800"
      preserveAspectRatio="xMidYMid slice"
    >
      <defs>
        <symbol id="heart" viewBox="-69 -16 138 138">
          <path d="M0,12 C 50,-30 110,50  0,120 C-110,50 -50,-30 0,12z" />
        </symbol>
      </defs>
    </svg>
    <svg
      class="editorial hidden"
      viewBox="0 24 150 28"
      preserveAspectRatio="none"
    >
      <defs>
        <path
          id="gentle-wave"
          d="m -160,44.4 c 30,0 58,
        -18 87.7,-18 30.3,0 58.3,
        18 87.3,18 30,0 58,-18 88,
        -18 30,0 58,18 88,18 l 0,
        34.5 -351,0 z"
        />
      </defs>
      <g class="loading-waves">
        <use xlink:href="#gentle-wave" x="50" y="0" fill="#00adee" />
        <use xlink:href="#gentle-wave" x="50" y="3" fill="#009fd7" />
        <use xlink:href="#gentle-wave" x="50" y="6" fill="#246a99" />
      </g>
    </svg>
    <div class="container">
      <h1>HGSU Async Voting ID Generator</h1>
      <a
        href="https://docs.google.com/document/d/1MsKRpN89cr-24vG7u7hHP00U2eYrTsrKQ_048wBVzEs/edit"
        target="_blank"
        >Reference Document</a
      >
      <div class="results">
        <p>
          <strong>p:</strong> <span id="prime-p">Not generated</span>
          <button type="button" class="edit-button" data-target="prime-p">
            Edit
          </button>
        </p>
        <p>
          <strong>q:</strong> <span id="prime-q">Not generated</span>
          <button type="button" class="edit-button" data-target="prime-q">
            Edit
          </button>
        </p>
        <p>
          <strong>c:</strong> <span id="c-value">Not generated</span>
          <button type="button" class="edit-button" data-target="c-value">
            Edit
          </button>
        </p>
      </div>
      <form id="prime-form">
        <button
          type="button"
          id="generateButton"
          name="generate_primes_and_calculate"
        >
          Generate Parameters
        </button>
      </form>
      <form id="upload-form" method="post" enctype="multipart/form-data">
        <input type="file" id="csv_file" name="file" />
        <input type="hidden" name="p" id="hidden-prime-p" />
        <input type="hidden" name="q" id="hidden-prime-q" />
        <input type="hidden" name="c" id="hidden-c-value" />
        <button type="submit" id="upload-button" disabled>
          Upload CSV and Generate IDs
        </button>
      </form>
    </div>
  </body>
</html>
